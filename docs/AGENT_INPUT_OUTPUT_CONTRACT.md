**1ï¸âƒ£ Agent invocation overview**

The Agent is invoked by the backend after a user message is safely stored.

The Agent:

-does NOT see raw HTTP
-does NOT see database internals
-receives a sanitized decision context



**2ï¸âƒ£ Agent INPUT (Backend â†’ Agent)**
ğŸ”¹ High-level structure
{
  "request_id": "uuid",
  "project": { ... },
  "user_message": { ... },
  "context": { ... },
  "system_rules": { ... }
}


Each section has a clear responsibility.

ğŸ”¹ request_id
"request_id": "uuid-v4"


Purpose:

tracing
debugging
log correlation
retry safety
Generated by backend.


ğŸ”¹ project
"project": {
  "id": 1,
  "name": "Legal templates",
  "settings": {
    "memory_enabled": true,
    "preferred_models": ["gpt-5.1", "gpt-4.1"],
    "max_cost_per_request": 0.50
  }
}


Notes:

Comes from DB
Settings are read-only for agent
JSONB allows future expansion

ğŸ”¹ user_message
"user_message": {
  "id": 123,
  "content": "I need a supplier contract template",
  "created_at": "2025-12-16T09:12:00Z"
}


Notes:

Agent never sees user_id
Identity & auth are backend concerns
Agent focuses on intent, not people

ğŸ”¹ context (retrieved knowledge)
"context": {
  "recent_messages": [
    { "role": "user", "content": "..." },
    { "role": "assistant", "content": "..." }
  ],
  "retrieved_documents": [
    {
      "source": "company_memory",
      "title": "Supplier Contract v2",
      "snippet": "This contract defines..."
    }
  ]
}


Notes:

Backend decides what context to send
Agent does NOT query DB itself
RAG stays backend-controlled

ğŸ”¹ system_rules
"system_rules": {
  "must_check_existing_templates": true,
  "prefer_reuse_over_generation": true,
  "allow_model_switching": true,
  "disallow_external_data": true
}


Purpose:

hard constraints
company policy
non-negotiable rules
Agent must comply.




3ï¸âƒ£ Agent OUTPUT (Agent â†’ Backend)
ğŸ”¹ High-level structure
{
  "decision": { ... },
  "confidence": 0.87,
  "notes": "Optional explanation"
}

ğŸ”¹ decision (REQUIRED)
"decision": {
  "intent": "template_request",
  "complexity": "medium",
  "action": "execute",
  "executor_type": "llm",
  "executor_task": {
    "task_type": "generate_template",
    "input_requirements": ["supplier_name", "jurisdiction"],
    "suggested_model": "gpt-4.1"
  }
}


Allowed values:

**intent:**

general_chat
template_request
analysis
document_question
unknown

**complexity:**
low
medium
high

**action:**

execute
ask_clarifying_questio
no_action

ğŸ”¹ executor_task (only if action = execute)

Defines what should be executed â€” not how.
Backend decides:
whether to approve
which executor to call
whether to queue or run inline

ğŸ”¹ confidence
"confidence": 0.0 - 1.0


Purpose:

debugging
future fallback logic
observability

ğŸ”¹ notes (optional)

Human-readable reasoning.
Useful for logs, audits, and debugging.



**4ï¸âƒ£ Hard guarantees**

The Agent:

MUST return valid JSON
MUST follow schema
MUST NOT invent fields
MUST NOT execute tools
MUST NOT write final responses

If output is invalid:

backend rejects it
fallback logic applies


**5ï¸âƒ£ Why this contract matters**

Because later you will want to:
swap Agent models
test agent behavior offline
simulate decisions
audit failures
improve prompts safely
This contract makes that possible.


